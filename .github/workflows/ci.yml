name: CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build and test
      run: |
        # Build Docker image
        docker build -t simple-go-app:latest .
        
        # Test the image
        docker run -d --name test-app -p 8080:8080 simple-go-app:latest
        sleep 5
        
        # Test health endpoint
        curl -f http://localhost:8080/health || exit 1
        
        # Test metrics endpoint  
        curl -f http://localhost:8080/metrics || exit 1
        
        docker stop test-app
        echo "âœ… Build and test passed"
    
    - name: Build and push to GitHub Registry
      run: |
        # Login to GitHub Container Registry
        echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        # Build and tag image
        docker build -t ghcr.io/chembartsev/simple-go-app:latest .
        
        # Push to GitHub Registry
        docker push ghcr.io/chembartsev/simple-go-app:latest
        
        echo "âœ… Image pushed to GitHub Registry"
    
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /app
          echo "ðŸš€ Starting deployment..."
          
          # Login to GitHub Registry
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Pull and restart
          docker-compose pull app
          docker-compose up -d
          
          echo "âœ… Deployment completed"
    
    - name: Deploy instructions
      run: |
        echo "To deploy manually:"
        echo "1. git pull"
        echo "2. docker-compose down"
        echo "3. docker-compose up -d --build"
        echo ""
        echo "Access:"
        echo "App: http://your-server"
        echo "Grafana: http://your-server:3000"
        echo "Prometheus: http://your-server:9090"
